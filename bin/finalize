#!/usr/bin/env bash
BUILD_PATH="${1}"
CACHE_PATH="${2}"
DEPS_PATH="${3}"
INDEX="${4}"

declare -r BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))

declare -r PROFILE_PATH="${BUILD_PATH}/.profile.d"

source ${BUILDPACK_DIR}/envrc

set_profile(){
    status "Setting app profile"
    [[ -d "${PROFILE_PATH}" ]] || mkdir -p "${PROFILE_PATH}"
    cp "${BUILDPACK_DIR}/deps/env.sh" "${PROFILE_PATH}/"
    chmod +x "${PROFILE_PATH}/env.sh"   
}

configure_app(){
    status "Configuring app"
    if [ -f "${CACHE_PATH}/prometheus.yml" ]
    then 
        #Note1: we should replace this with envsubt when it is avialbe
        #Note2: We should remove this hack if and when prometheus start to support env vars in config filr
        eval "echo \"$(cat ${CACHE_PATH}/prometheus.yml)\"" > "${BUILD_PATH}/prometheus.yml"
    fi
}

main(){
    set_profile
    configure_app
}

main